var datafile="data.json",morefile="more.json";$(document).ready(function(){function t(t){var e=[];t.map(function(t){var n=Math.round(l(t.weight));0===e.length&&(n+=4),e.push([t.word,n])});var n=document.getElementById("cloudcanvas");cwidth=900,cheight=500,n.width=cwidth,n.height=cheight,n.style.width=cwidth,n.style.height=cheight,WordCloud(document.getElementById("cloudcanvas"),{list:e,backgroundColor:"#dfdfde",gridSize:12,weightFactor:16})}function e(t){function e(){var t=f(E),e=d3.layout.tree().links(t);A.nodes(t).links(e).start(),D=D.data(e,function(t){return t.target.id}),D.exit().remove(),D.enter().insert("line",".node").attr("class","link"),S=S.data(t);var a=S.enter().append("g").attr("class","node").on("click",h).call(A.drag);a.append("circle").attr("r",function(){return 10}),a.append("text").attr("dy",".35em").text(function(t){return t.hasOwnProperty("lemma")?t.lemma:t.hasOwnProperty("name")?t.name:t.hasOwnProperty("chapter")?t.chapter:void 0}),a.select("circle").style("fill",n).style("stroke-width",5).style("stroke-opacity",.8).style("fill-opacity",function(t){return t.pos?.3:1}).style("stroke",s),S.exit().remove()}function n(t){return t.pos?"N"===t.pos[0]?"#ff0000":"V"===t.pos[0]?"#00ff00":"#0000ff":"orange"}function l(){D.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),S.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}function s(t){return t._children?"#3182bd":t.children?"#c6dbef":u(t.polarity)}function u(t){if(!t)return"#aaaa44";t=Math.round(100*t),t>100?t=100:0>t&&(t=0);var e=Math.floor(255*t/100),n=Math.floor(255*(100-t)/100),a=155;return"#"+((n<<16)+(e<<8)+a).toString(16)}function h(t){d3.event.defaultPrevented||(t.children?(t._children=t.children,t.children=null):(t.children=t._children,t._children=null),e())}function f(t){function e(t){t.children&&t.children.forEach(e),t.id||(t.id=++a),n.push(t)}var n=[],a=0;return e(t),n}function p(){evolveData=[];for(var t=E.children,e=0;e<t.length;e++){for(var n=t[e].children,a=t[e].chapter,r=1,i=0,o=0,c=0,d=0;d<n.length;d++){var l=n[d].polarity;l&&(c++,l>i&&(i=l),r>l&&(r=l),o+=l)}o/=c,isNaN(o)||evolveData.push({chapter:a,median:o,min:r,max:i})}return evolveData.sort(function(t,e){var n=t.chapter,a=e.chapter;return n==a?0:n>a?1:-1}),evolveData}function v(t,e,n,a,r,i){var o=t.append("g").attr("clip-path","url(#axes-clip)");o.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(e),o.append("g").attr("class","y axis").call(n)}function g(t,e,n,a){var r=d3.svg.area().interpolate("basis").x(function(t){return n(t.chapter)}).y0(function(t){return a(t.max)}).y1(function(t){return a(t.median)}),i=d3.svg.line().interpolate("basis").x(function(t){return n(t.chapter)}).y(function(t){return a(t.median)}),o=d3.svg.area().interpolate("basis").x(function(t){return n(t.chapter)}).y0(function(t){return a(t.median)}).y1(function(t){return a(t.min)});t.datum(e),t.append("path").attr("class","area upper inner").attr("d",r),t.append("path").attr("class","area lower inner").attr("d",o),t.append("path").attr("class","median-line").attr("d",i),e.forEach(function(e){t.append("circle").attr("class","dotmarker").attr("r",5).attr("cx",n(e.chapter)).attr("cy",a(e.median))})}function m(t){var e,n=960,a=500,r={top:20,right:20,bottom:40,left:40},o=n-r.left-r.right,d=a-r.top-r.bottom,l=d3.scale.linear().range([0,o]).domain([0,i]),s=d3.scale.linear().range([d,0]).domain([0,d3.max(t,function(t){return t.max})]),u=d3.svg.axis().scale(l).orient("bottom").innerTickSize(-d).outerTickSize(0).tickPadding(10),h=d3.svg.axis().scale(s).orient("left").innerTickSize(-o).outerTickSize(0).tickPadding(10);c?(e=c,e.selectAll("*").remove()):(e=d3.select("#ds-evolution").append("svg").attr("width",n).attr("height",a).append("g").attr("transform","translate("+r.left+","+r.top+")"),c=e);e.append("clipPath").attr("id","rect-clip").append("rect").attr("width",0).attr("height",d);v(e,u,h,r,o,d),g(e,t,l,s)}if(a){var y=$("#detailselect");if(d){for(var k=0;k<a.nodes.length;k++)y.append("<option id="+a.nodes[k].index+">"+a.nodes[k].name+"</option>");d=!1}if(r||0===r){var x=jQuery.extend(!0,{},a),w=[],b=x.nodes[r].id;x.links.forEach(function(t){if(t.source==b){var e=x.nodes.filter(function(e){return e.id==t.target})[0];w.push(e.name)}if(t.target==b){var n=x.nodes.filter(function(e){return e.id==t.source})[0];w.push(n.name)}});var C=$("#ds-links-content");C.empty(),C.append("<ul>");for(var T=0;T<w.length;T++)C.append("<li>"+w[T]+"</li>");C.append("</ul>"),t||(y.find("option")[r+1].selected=!0),$("#ptitle").text(x.nodes[r].name);var z,E=x.nodes[r],P=.6*$(window).width(),j=$(window).height(),A=d3.layout.force().linkDistance(40).charge(-220).gravity(.05).size([P,j]).on("tick",l);o?(z=o,z.selectAll("*").remove()):(z=d3.select("#ds-graph").append("svg").attr("width",P).attr("height",j),o=z);var D=z.selectAll(".link"),S=z.selectAll(".node");e(),m(p())}}}function n(){function t(){u.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function e(){d3.event.sourceEvent.stopPropagation(),d3.select(this).classed("dragging",!0),d.start()}function n(t){d3.select(this).attr("cx",t.x=d3.event.x).attr("cy",t.y=d3.event.y)}function i(){d3.select(this).classed("dragging",!1)}if(!a){var o=$(window).width()-250,c=$(window).height()-250,d=d3.layout.force().charge(-220).linkDistance(100).size([o,c]),l=d3.behavior.zoom().scaleExtent([.1,10]).on("zoom",t),s=d3.select("#networkcontent").append("svg").attr("width",o).attr("height",c).call(l).attr("transform","translate(-5,-5)"),u=s.append("g"),h=d3.behavior.drag().origin(function(t){return t}).on("dragstart",e).on("drag",n).on("dragend",i);d3.json(datafile,function(t,e){function n(t){r&&$(e.nodes[r]).removeClass("active"),r=t.index,$(e.nodes[r]).addClass("active")}var i=[];a=e,e.links.forEach(function(t){var n=e.nodes.filter(function(e){return e.id===t.source})[0],a=e.nodes.filter(function(e){return e.id===t.target})[0];i.push({source:n,target:a,value:t.value})}),d.nodes(e.nodes).links(i).start();var o=u.append("g").selectAll(".link").data(i).enter().append("line").attr("class","link").style("stroke-width",function(t){return Math.sqrt(t.value)}),c=u.append("g").attr("class","nodes").selectAll("g.node").data(e.nodes).enter().append("g").attr("class","node").call(h);c.append("circle").attr("r",7).attr("fill",function(t){return t.children.length>0?"#014d6a":"#a83f00"}).on("click",function(t){r?$(c[0][r].children[0]).attr("fill",e.nodes[r].children.length>0?"#014d6a":"#a83f00"):0===r&&$(c[0][r].children[0]).attr("fill",e.nodes[r].children.length>0?"#014d6a":"#a83f00"),$(c[0][t.index].children[0]).attr("fill","green"),n(t)}),c.append("text").attr("dx",12).attr("dy",".35em").text(function(t){return t.name}),d.on("tick",function(){o.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),c.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})})})}}var a,r,i,o,c,d=!0;$("#selectbutton").on("click",function(){r=$("#detailselect").find("option:selected").attr("id"),e(!0)}),d3.json(morefile,function(e,n){return e?($("#content").hide(),void $("body").append("<h1>Error!</h1><p>No data found! Please make sure that <code>data.json</code> and <code>more.json</code> exist in this directory.</p>")):(i=n.maxChapterNumber,void t(n.words))});var l=(d3.scale.category20(),d3.scale.log());$("#networkcontent").hide(),$("#detailcontent").hide(),$("#detail").on("click",function(){var t=$("#cloud");t.hasClass("activeTab")&&t.removeClass("activeTab"),$("#cloudcontent").hide();var n=$("#network");n.hasClass("activeTab")&&n.removeClass("activeTab"),$("#networkcontent").hide(),$("#detailcontent").show(),$("#detail").addClass("activeTab"),e()}),$("#network").on("click",function(){var t=$("#cloud");t.hasClass("activeTab")&&t.removeClass("activeTab"),$("#cloudcontent").hide();var e=$("#detail");e.hasClass("activeTab")&&e.removeClass("activeTab"),$("#detailcontent").hide(),$("#networkcontent").show(),$("#network").addClass("activeTab"),n()}),$("#cloud").addClass("activeTab").on("click",function(){$("#cloudcontent").show(),$("#cloud").addClass("activeTab");var t=$("#detail");t.hasClass("activeTab")&&t.removeClass("activeTab"),$("#detailcontent").hide();var e=$("#network");e.hasClass("activeTab")&&e.removeClass("activeTab"),$("#networkcontent").hide()})});